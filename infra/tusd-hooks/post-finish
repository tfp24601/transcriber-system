#!/bin/bash

# Tusd post-finish hook  
# Called when upload is completed - triggers n8n webhook

# Log the completion
echo "$(date): Upload completed - ID: $TUS_ID, Size: $TUS_SIZE bytes" >> /tmp/tusd.log

# Prepare webhook payload
UPLOAD_ID="$TUS_ID"
FILE_SIZE="$TUS_SIZE"
FILE_PATH="/data/uploads/$TUS_ID"
UPLOAD_METADATA="$TUS_METADATA"

# Parse metadata 
MODE="single"  # Default
NAME=""
SOURCE="tusd"

if [[ -n "$UPLOAD_METADATA" ]]; then
    IFS=',' read -ra METADATA_PAIRS <<< "$UPLOAD_METADATA"
    for pair in "${METADATA_PAIRS[@]}"; do
        IFS=' ' read -ra KEYVALUE <<< "$pair"
        if [[ ${#KEYVALUE[@]} -eq 2 ]]; then
            KEY="${KEYVALUE[0]}"
            VALUE=$(echo "${KEYVALUE[1]}" | base64 -d 2>/dev/null || echo "${KEYVALUE[1]}")
            
            case "$KEY" in
                mode) MODE="$VALUE" ;;
                name) NAME="$VALUE" ;;
                source) SOURCE="$VALUE" ;;
            esac
        fi
    done
fi

# Default name if not provided
if [[ -z "$NAME" ]]; then
    NAME="upload_$(date +%Y%m%d%H%M%S)"
fi

# Send webhook to n8n
curl -X POST http://n8n:5678/webhook/tus-upload-complete \
    -H "Content-Type: application/json" \
    -d "{
        \"upload_id\": \"$UPLOAD_ID\",
        \"file_path\": \"$FILE_PATH\", 
        \"file_size\": $FILE_SIZE,
        \"mode\": \"$MODE\",
        \"name\": \"$NAME\",
        \"source\": \"$SOURCE\"
    }" \
    >> /tmp/tusd.log 2>&1

echo "$(date): Webhook sent to n8n for upload $UPLOAD_ID" >> /tmp/tusd.log

exit 0