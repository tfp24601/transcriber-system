# --- Transcriber System Routes ---

# --- Main transcriber web interface ---
http://transcriber.solfamily.group {
    # Security headers
    header {
        X-Frame-Options DENY
        X-Content-Type-Options nosniff
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        X-Robots-Tag "noindex, nofollow"
        Permissions-Policy "microphone=(), camera=(), geolocation=()"

        # CORS for API requests
        Access-Control-Allow-Origin "https://transcriber.solfamily.group"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers "Authorization, Content-Type, CF-Access-Jwt-Assertion, Cf-Access-Authenticated-User-Email, X-Dev-User-Email"
    }

    # Handle preflight requests
    @cors_preflight method OPTIONS
    respond @cors_preflight 200

    # API routes to n8n webhooks
    # Detail: recording by ID (workflow 04)
    # Recordings route healthcheck (for debugging route match)
    @rec_health path /api/recordings/healthcheck
    handle @rec_health {
        header Content-Type text/plain
        respond "OK recordings match" 200
    }

    @rec_detail path_regexp recdet ^/api/recordings/(.+)$
    handle @rec_detail {
        # Proxy to workflow 04 (recording detail)
        rewrite * /webhook/e938fac8-a0f9-47b3-a706-92b5f6fa4e1d/api/recordings/{http.regexp.recdet.1}
        reverse_proxy 192.168.50.10:5678 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Cf-Access-Authenticated-User-Email {header.cf-access-authenticated-user-email}
            header_up X-Dev-User-Email {http.request.header.x-dev-user-email}
        }
    }

    # List recordings - constrain to exact path so it doesn't shadow the detail route above
    @recordings_list path /api/recordings
    handle @recordings_list {
        rewrite * /webhook/api/recordings
        reverse_proxy 192.168.50.10:5678 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Cf-Access-Authenticated-User-Email {header.cf-access-authenticated-user-email}
            header_up X-Dev-User-Email {http.request.header.x-dev-user-email}
        }
    }

    # Jobs route healthcheck (for debugging route match)
    @jobs_health path /api/jobs/healthcheck
    handle @jobs_health {
        header Content-Type text/plain
        respond "OK jobs match" 200
    }

    # Job status by ID (workflow 05)
    @jobs path_regexp jobs ^/api/jobs/(.+)$
    handle @jobs {
        # Proxy to workflow 05 (job status)
        rewrite * /webhook/20fa5f02-a49f-40d0-83c6-62a995ccdec7/api/jobs/{http.regexp.jobs.1}
        reverse_proxy 192.168.50.10:5678 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Cf-Access-Authenticated-User-Email {header.cf-access-authenticated-user-email}
            header_up X-Dev-User-Email {http.request.header.x-dev-user-email}
        }
    }


    # File ingest endpoint to n8n webhook
    handle /ingest {
        rewrite * /webhook/ingest
        reverse_proxy 192.168.50.10:5678 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Cf-Access-Authenticated-User-Email {header.cf-access-authenticated-user-email}
            header_up X-Dev-User-Email {http.request.header.x-dev-user-email}
        }
    }

    # Resumable uploads to tusd
    handle /uploads/* {
        reverse_proxy 192.168.50.10:1080 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # File downloads - proxy with auth check
    handle /downloads/* {
        reverse_proxy 192.168.50.10:5678 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Main web app (default)
    handle {
        reverse_proxy 192.168.50.10:3010 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Logging
    log {
        output file /var/log/caddy/transcriber.log
        format json
    }
}